#!/bin/bash

echo "\n"
echo "This is a script of `basename "$0"`"
dirsub="$(dirname "$0")"

rm -f $dirsub/LATEST/Translated.ass 
rm -f $dirsub/LATEST/Final.mp4
echo "dir setup complete"

for f in `find $dirsub/LATEST`; do mv -v "$f" "`echo $f | tr '[A-Z]' '[a-z]'`" ; done
mv $dirsub/latest $dirsub/LATEST
mv $dirsub/LATEST/test.* $dirsub/LATEST/test.txt 2>/dev/null
mv $dirsub/LATEST/*.ass $dirsub/LATEST/Source.ass 2>/dev/null
mv $dirsub/LATEST/*.mp4 $dirsub/LATEST/Source.mp4 2>/dev/null
cp $dirsub/LATEST/Source.ass $dirsub/LATEST/Translated.ass 2>/dev/null
echo "files preparation completed"

#if [ ! -f $dirsub/LATEST/Source.ass ] || [ ! -f $dirsub/LATEST/Source.mp4 ] ; then echo "Error: no file found" && exit 0; fi
#if grep -q "蓝胖子" $dirsub/LATEST/Source.ass; then echo "dir checking complete"; else rm -f $dirsub/LATEST/Translated.ass && echo "Error: no keyword found" && exit 0; fi

echo abc
sed -i '' 's!@FZCuYuan-M03S!PingFang HK!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!A-OTF Shin Maru Go Pro M!PingFang HK!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!Alibaba PuHuiTi!PingFang HK!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!DFGMaruGothic-Md!EPSON ëæä€ÉSÉVÉbÉNëÃÇa!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!DFMaruGothic-Md!EPSON ëæä€ÉSÉVÉbÉNëÃÇa!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!EPSON 太丸ゴシック体Ｂ!EPSON ëæä€ÉSÉVÉbÉNëÃÇa!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!FZCuYuan-M03!Gen Jyuu Gothic XP!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!FZLanTingHei-B-GBK!Gen Jyuu Gothic XP!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!FZLanTingYuanS-B-GB!Gen Jyuu Gothic XP!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!FZSJ-WOXWSYSD!Gen Jyuu Gothic XP!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!FZYunDongHeiS-M-GB!Gen Jyuu Gothic XP!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!Moonstar!PingFang HK!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!Times New Roman!Times New Roman!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!华康少女文字W5-A!DFPChuW4-B5!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!微软雅黑!PingFang HK!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!方正兰亭粗黑_GBK!PingFang HK!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!方正喵呜体!PingFang HK!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!方正少儿_GBK!Gen Jyuu Gothic XP!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!方正晶准黑!PingFang HK!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!方正琥珀_GBK!Heiti TC!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!方正粗圆_GBK!DFPChuW4-B5!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!方正粗圆简体!DFPChuW4-B5!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!方正综艺简体!PingFang HK!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!楷体!PingFang HK!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!汉仪太极(哆啦)!PingFang HK!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!汉仪超粗圆简!Gen Jyuu Gothic XP!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!长城特粗圆体!Gen Jyuu Gothic XP!g'  $dirsub/LATEST/Translated.ass
echo "translated font"


filech=$(grep -F "Video File: " $dirsub/LATEST/Translated.ass | sed 's/Video File: //g')
sed -i '' "s!$filech!Source.mp4!"  $dirsub/LATEST/Translated.ass
echo "changed Aegisub dir"

sed -i '' 's!\[蓝胖子\]对白-ch!哆啦对白-CN!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!\[蓝胖子\]对白-JP!哆啦对白-JP!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!\[蓝胖子\]主题曲!OP-CN!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!\[蓝胖子\]片尾曲!歌词-CN!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!\[蓝胖子\]提供左右字幕（換行）!提供左右字幕（換行）!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!\[蓝胖子\]道具!哆啦A梦-道具!g'  $dirsub/LATEST/Translated.ass
sed -i '' 's!制作人员!提供下!g'  $dirsub/LATEST/Translated.ass
echo "subs name transited"

sed -i '' 's!40,\&H00FBFBFD,\&H000000FF,\&H00060606,\&H00E4CD83,-1,0,0,0,100,100,0,0,1,2,0,2,9,9,10,1!43,\&H00FEFEFE,\&H000000FF,\&H00030303,\&H00E4CD83,0,0,0,0,100,100,0,0,1,2,0,2,9,9,5,1!'  $dirsub/LATEST/Translated.ass
sed -i '' 's!70,\&H00E8CD2B,\&H000000FF,\&H00FFFFFF,\&H00E4CD83,-1,0,0,0,100,100,0,0,1,5,0,2,9,9,60,1!70,\&H00FEFEFE,\&H000000FF,\&H00040404,\&H00E4CD83,0,0,0,0,100,100,0,0,1,2,0,2,9,9,65,1!'  $dirsub/LATEST/Translated.ass
echo "style transformed"

opencc -i $dirsub/LATEST/Translated.ass -o $dirsub/LATEST/Translated.ass
echo "translated text"

title=$(grep -F "標題" $dirsub/LATEST/Translated.ass | grep -F "Dialogue" | awk '!/bord0/' | sed 's/.*,,0,0,0,,//' | rev | cut -d ')' -f1 | cut -d '}' -f1 | rev | uniq | paste -sd '|' - | tr -dc '[:print:]'| sed 's/ //g' | sed 's/|/ + /g')
echo "title grabbed ($title)"

sed -i '' 's!喫!吃!g' $dirsub/LATEST/Translated.ass
sed -i '' 's!纔!才!g' $dirsub/LATEST/Translated.ass
sed -i '' 's!#!!g' $dirsub/LATEST/Translated.ass
sed -i '' 's!啥!什麼!g' $dirsub/LATEST/Translated.ass
sed -i '' 's!嗯!恩!g' $dirsub/LATEST/Translated.ass
echo "translate text fixed"

sed -i '' 's/0,0,0,0,100,100,0,0,1,2,0,2,9,9,53,1/0,0,0,0,100,100,0,0,1,2,0,2,9,9,60,1/' $dirsub/LATEST/Translated.ass
echo "font text moved"

if [ ! -f $dirsub/LATEST/test.txt ]; then mv $dirsub/LATEST/ "$dirsub/"$((1+$(ls $dirsub | sort -nr | head -n1 | grep -Eo '[0-9]{1,5}'))) && mkdir $dirsub/LATEST && dirsub=$dirsub/$(ls $dirsub | sort -nr | head -n1 | grep -Eo '[0-9]{1,5}') && echo "Moved dir to "$(echo $dirsub | grep -o '[^/]*$'); else echo 'Test Mode - NOT moving any files' && dirsub=$dirsub/LATEST; fi


ffmpeg -i $dirsub/Source.mp4 -vf ass=$dirsub/Translated.ass $dirsub/Final.mp4 -y
echo "output complete"

title=$(echo $dirsub | grep -o '[^/]*$')"【"$title"】"
echo "title complete"

echo "哆啦A夢 新番 "$title" 日語繁中"
echo "https://www.youtube.com/upload"
echo "\n"
echo "哆啦A夢 新番 "$title" 日語繁中"
echo "哆啦A夢 新番 日語 繁體中文字幕""\n""主頻道：https://www.youtube.com/channel/UC-4WJFw0IJwrOlv2zQBwUZQ""\n""""\n""--------------""\n""【版權聲明】""\n""本視頻僅提供予(1)學習日語的人士 (2)失聰或聽覺有問題的人或身體上或精神上有其他方面殘障的人""\n""爲確保影片版權符合公平使用原則，(1)爲免影響該作品的潛在市場價值或價值（如電視台購買特輯），本頻道只會連載最多10期影片 (2)本頻道並不會開啓任何盈利功能，若有廣告產生，則爲版權持有人開啓""\n""若版權持有人對本影片有任何申訴，請傳送電郵至binary.in.love.520@gmail.com，本影片會立刻下架。"
echo "https://spee.ch/a/e41f0dc4f4395a47.png"
echo "Doraemon, 哆啦A夢, 新番, Japanese, Kartoon"
echo "https://odysee.com/$/upload"
exit 0


#echo 'export subs_op=' >> ~/.bash_profile

#awk '{print;print;}' /Users/ansoncheng/subs/YY_Doraemon/LATEST/Untitled.ass > /Users/ansoncheng/subs/YY_Doraemon/LATEST/Untitled1.ass  
#cat /Users/ansoncheng/subs/YY_Doraemon/LATEST/Untitled1.ass| grep -o '^.*,' |rev |awk 'NR%2{$0="some text "$0}1'|rev > /Users/ansoncheng/subs/YY_Doraemon/LATEST/Untitled2.ass 
#sed -i '' 's!Default,,0,0,0,, txet emos![蓝胖子]对白-ch,,0,0,0,,!'  /Users/ansoncheng/subs/YY_Doraemon/LATEST/Untitled2.ass 
#sed -i '' 's!Default,,0,0,0,,![蓝胖子]对白-JP,,0,0,0,,!'  /Users/ansoncheng/subs/YY_Doraemon/LATEST/Untitled2.ass 